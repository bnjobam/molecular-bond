import pickle
import pandas as pd
import numpy as np
from tqdm import tqdm

folder='.../GitHub/molecular bond'

def evaluate(model, data):
    n=data.shape[0]
    table=pd.DataFrame(np.zeros((n,len(cols))))
    table.columns=cols
    for i in tqdm(range(n)):
        k=data.atom_index_0[i]
        table.iloc[i][[f'atom_index_0{k}']]=1
        k1=data.atom_index_1[i]
        table.iloc[i][[f'atom_index_1{k1}']]=1
        k2=data.type[i]
        table.iloc[i][[f'{k2}']]=1

    y1=model[0].predict(table)
    y2=model[1].predict(table)
    y3=model[2].predict(table)

    y=np.column_stack((y1,y2,y3))
    Y=model[3].predict(y)
    return Y
test_data=pd.read_csv(folder+'/test.csv')

regressor=open(folder+'/models/aggregate_model.py', 'rb')
model=pickle.load(regressor)
regressor.close()

cols=pd.read_csv(folder+'/columns.csv')
cols=list(cols.iloc[:,0])

predictions=evaluate(model,test_data)
Result=pd.concat([test.id,pd.DataFrame(predictions)], axis=1)
Result.columns=['id','scalar_coupling_constant']
Result.to_cvs(folder+'/Result.csv')
